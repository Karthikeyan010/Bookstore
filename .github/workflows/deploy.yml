name: CI/CD for React + Spring Boot on GKE

on:
  push:
    branches:
      - main 

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  REACT_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/bookstore-frontend
  SPRING_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/cart-service
  CATALOG_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/catalog-service

jobs:
  build:
    name: Build & Deploy to GKE
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensures full repo checkout

      - name: ğŸ›  Debug - Verify Repository Structure
        run: |
          echo "Current Directory: $(pwd)"
          echo "List of files and directories:"
          ls -R  # Print all files & directories for debugging

      - name: ğŸ”‘ Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          create_credentials_file: true
          export_environment_variables: true
          cleanup_credentials: true

      - name: ğŸ›  Set Up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: ğŸ›  Install GKE Authentication Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: ğŸ›  Configure Docker Authentication for GCR
        run: gcloud auth configure-docker gcr.io

      ### **Build Spring Boot JAR Files Before Dockerizing**
      - name: ğŸ—ï¸ Build Spring Boot Application (Cart Service)
        run: |
          cd cart-service
          chmod +x mvnw  # Ensure wrapper is executable
          ./mvnw clean package -DskipTests  # Build the JAR file
          ls -l target/  # Verify JAR file exists
          cd ..

      - name: ğŸ—ï¸ Build Spring Boot Application (Catalog Service)
        run: |
          cd catalog-service
          chmod +x mvnw  # Ensure wrapper is executable
          ./mvnw clean package  # Build the JAR file
          ls -l target/  # Verify JAR file exists
          cd ..

      - name: ğŸ—ï¸ Build & Push React Frontend Docker Image
        run: |
          docker build -t $REACT_IMAGE:latest ./bookstore-frontend
          docker push $REACT_IMAGE:latest

      - name: ğŸ—ï¸ Build & Push Spring Boot Backend (Cart Service) Docker Image
        run: |
          docker build --build-arg JAR_FILE=target/cart-service-0.0.1-SNAPSHOT.jar -t $SPRING_IMAGE:latest ./cart-service
          docker push $SPRING_IMAGE:latest

      - name: ğŸ—ï¸ Build & Push Catalog Service Docker Image
        run: |
          docker build --build-arg JAR_FILE=target/catalog-service-0.0.1-SNAPSHOT.jar -t $CATALOG_IMAGE:latest ./catalog-service
          docker push $CATALOG_IMAGE:latest

      - name: ğŸ”— Get GKE Credentials
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $PROJECT_ID

      - name: ğŸ” Verify Kubernetes Cluster Connection
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods --all-namespaces
          
      - name: ğŸš€ Deploy to GKE
        run: |
          kubectl apply -f k8s/
          kubectl rollout restart deployment/bookstore-frontend
          kubectl rollout restart deployment/cart-service
          kubectl rollout restart deployment/catalog-service
          kubectl rollout status deployment/bookstore-frontend
          kubectl rollout status deployment/cart-service
          kubectl rollout status deployment/catalog-service

      - name: ğŸ›  Debug Kubernetes Pods & Logs
        if: failure()
        run: |
          kubectl get pods -A
          kubectl describe pods -A
          kubectl logs -l app=bookstore-frontend --tail=50
          kubectl logs -l app=cart-service --tail=50
          kubectl logs -l app=catalog-service --tail=50
